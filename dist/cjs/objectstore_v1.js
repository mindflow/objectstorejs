'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var coreutil_v1 = require('coreutil_v1');
var containerbridge_v1 = require('containerbridge_v1');

class IndexConfig {

    /**
     * 
     * @param {String} name 
     * @param {String} path 
     * @param {Boolean} unique 
     */
    constructor(name, path, unique) {

        /** @type {String} */
        this.name = name;

        /** @type {String} */
        this.path = path;

        /** @type {Boolean} */
        this.unique = unique;
    }

}

class StoreConfig {

    constructor() {

        /** @type {String} */
        this.storeName = null;

        /** @type {String} */
        this.keyPath = null;

        /** @type {List<IndexConfig>} */
        this.indexList = new coreutil_v1.List();

    }

    /**
     * 
     * @param {String} storeName 
     */
    withStoreName(storeName) {
        this.storeName = storeName;
        return this;
    }

    /**
     * 
     * @param {String} storeName 
     */
    withKeyPath(keyPath) {
        this.keyPath = keyPath;
        return this;
    }

    /**
     * 
     * @param {String} storeName 
     */
    withIndex(name, path, unique) {
        this.indexList.add(new IndexConfig(name, path, unique));
        return this;
    }

}

class DbConfig {


    constructor() {

        /** @type {Number} */
        this.version = 1;

        /** @type {List<StoreConfig} */
        this.storeConfigList = new coreutil_v1.List();
    }

    /**
     * 
     * @param {Number} version 
     */
     withVersion(version) {
        this.version = version;
        return this;
    }

    /**
     * 
     * @param {StoreConfig} storeConfig 
     */
    withStoreConfig(storeConfig) { 
        this.storeConfigList.add(storeConfig);
        return this;
    }


}

const LOG$1 = new coreutil_v1.Logger("StoreConfig");

class DBConfigurer {

    /**
     * 
     * @param {DbConfig} dbConfig 
     */
    constructor(dbConfig) {
        this.dbConfig = dbConfig;
    }

    /**
     * 
     * @param {IDBVersionChangeEvent} versionChangeEvent 
     */
    updgrade(versionChangeEvent) {
        LOG$1.info("Upgrade needed");

        /** @type {IDBDatabase} */
        const db = versionChangeEvent.target.result;

        this.dbConfig.storeConfigList.forEach((storeConfig) => {

            // Clear the old
            if (db.objectStoreNames.contains(storeConfig.storeName)) {
                db.deleteObjectStore(storeConfig.storeName);
            }
    
            // Create the new
            const store = db.createObjectStore(
                storeConfig.storeName, 
                { keyPath: storeConfig.keyPath }
            );
    
            storeConfig.indexList.forEach((indexConfig) => {
                const index = store.createIndex(
                    indexConfig.name, 
                    indexConfig.path, 
                    {unique: indexConfig.unique}
                );
                return true;
            });

            return true;
        });
    }

}

class SubscriptionManager {

    constructor() {
        this.putSubscribers = new coreutil_v1.List();
        this.deleteSubscribers = new coreutil_v1.List();
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @param {ObjectFunction} putSubscriber 
     */
    subscribePut(putSubscriber) {
        if (putSubscriber instanceof coreutil_v1.ObjectFunction) {
            this.putSubscribers.add(new WeakRef(putSubscriber));
        }
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @param {ObjectFunction} deleteSubscriber 
     */
     subscribeDelete(deleteSubscriber) {
        if (deleteSubscriber instanceof coreutil_v1.ObjectFunction) {
            this.deleteSubscribers.add(new WeakRef(deleteSubscriber));
        }
    }

    notifyPut(entity) {
        let toRemoveArray = [];
        this.putSubscribers.forEach((weakRefSubscriber, parent) => {
            /** @type {ObjectFunction} */
            let subscriber = weakRefSubscriber.deref();
            if (!subscriber) {
                toRemoveArray.push(weakRefSubscriber);
            } else {
                subscriber.call(entity);
            }
            return true;
        }, this);
        new coreutil_v1.List(toRemoveArray).forEach((toRemove, parent) => {
            this.putSubscribers.remove(toRemove);
        });
    }

    notifyDelete(key) {
        let toRemoveArray = [];
        this.deleteSubscribers.forEach((weakRefSubscriber, parent) => {
            /** @type {ObjectFunction} */
            let subscriber = weakRefSubscriber.deref();
            if (!subscriber) {
                toRemoveArray.push(weakRefSubscriber);
            } else {
                subscriber.call(key);
            }
            return true;
        }, this);
        new coreutil_v1.List(toRemoveArray).forEach((toRemove, parent) => {
            this.deleteSubscribers.remove(toRemove);
        });
    }

}

/**
 * Manages a database with 0 to many stores
 */
class DBManager {

    /**
     * 
     * @param {IDBDatabase} db 
     */
    constructor(db) {
        
        /** @type {IDBDatabase} */
        this.db = db;

        /** @type {Map<SubscriptionManager>} */
        this.subscriptionManagerMap = new coreutil_v1.Map();
    }

    /**
     * 
     * @param {String} dbName 
     * @param {DbConfig} dbConfig 
     * @return {Promise}
     */
    static fromStore(dbName, dbConfig) {
        const dbConfigurer = new DBConfigurer(dbConfig);
        return new Promise((resolve, reject) => {
            const openRequest = containerbridge_v1.ContainerDatabaseStorage.open(dbName, dbConfig.version);
            openRequest.onerror = (error) => {
                LOG.error(error);
                reject(error);
            };
            openRequest.onsuccess = () => {
                resolve(new DBManager(openRequest.result));
            };
            openRequest.onupgradeneeded = dbConfigurer.updgrade.bind(dbConfigurer);
        });
    }

    /**
     * @returns {Object}
     */
    static mapEntity(type, dataObject) {
        if (dataObject) {
            return Object.assign(new type, dataObject);
        }
        return null;
    }


    /**
     * 
     * @param {String} storeName 
     * @param {IDBTransactionMode} transactionType readwrite
     * @returns {IDBTransaction}
     */
    transaction(transactionType, storeName) {
        return this.db.transaction(storeName, transactionType);
    }

    /**
     * 
     * @param {IDBTransaction} transaction
     * @param {String} storeName
     * @returns {IDBOjectStore}
     */
    objectStore(transaction, storeName) {
        return transaction.objectStore(storeName);
    }

    /**
     * 
     * @param {IDBObjectStore} objectStore 
     * @param {String} indexName
     * @returns {IDBIndex}
     */
    index(objectStore, indexName) {
        return objectStore.index(indexName);
    }

    /**
     * @param {Object} entity
     * @param {String} storeName
     * @return {Promise}
     */
    putEntity(entity, storeName) {
        const transaction = this.transaction("readwrite", storeName);
        const store = transaction.objectStore(storeName);
        const putRequest = store.put(entity);
        const context = this;
        return new Promise((resolve, reject) => {
            putRequest.onsuccess = () => { context.notifyPut(entity, storeName); resolve(entity); };
            putRequest.onerror = (error) => { reject(error); };
        });
    }


        /**
     * 
     * @param {String} key 
     * @param {String} storeName
     * @param {Class} type
     * @returns {Promise}
     */
    getEntity(key, type, storeName) {
        const transaction = this.transaction("readonly", storeName);
        const userStore = transaction.objectStore(storeName);
        const getRequest = userStore.get(key);
        return new Promise((resolve, reject) => {
            getRequest.onsuccess = () => { resolve(DBManager.mapEntity(type, getRequest.result)); };
            getRequest.onerror = (error) => { reject(error); };
        });
    }

    /**
     * 
     * @param {String} key 
     * @param {String} storeName
     * @returns {Promise}
     */
    deleteEntity(key, storeName) {
        const transaction = this.transaction("readwrite", storeName);
        const store = transaction.objectStore(storeName);
        const deleteRequest = store.delete(key);
        const context = this;
        return new Promise((resolve, reject) => {
            deleteRequest.onsuccess = () => {  context.notifyDelete(key, storeName); resolve(deleteRequest.result); };
            deleteRequest.onerror = (error) => {reject(error); };
        });
    }

    notifyDelete(key, storeName) {
        if (this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.get(storeName).notifyDelete(key);
        }
    }

    notifyPut(entity, storeName) {
        if (this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.get(storeName).notifyPut(entity);
        }
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @type {String} storeName
     * @type {ObjectFunction} putObjectFunction
     */
    subscribePut(storeName, putObjectFunction) {
        if (!this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.set(storeName, new SubscriptionManager());
        }
        this.subscriptionManagerMap.get(storeName).subscribePut(putObjectFunction);
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @type {String} storeName
     * @type {ObjectFunction} deleteObjectFunction
     */
    subscribeDelete(storeName, deleteObjectFunction) {
        if (!this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.set(storeName, new SubscriptionManager());
        }
        this.subscriptionManagerMap.get(storeName).subscribeDelete(deleteObjectFunction);
    }

}

exports.DBConfigurer = DBConfigurer;
exports.DBManager = DBManager;
exports.DbConfig = DbConfig;
exports.IndexConfig = IndexConfig;
exports.StoreConfig = StoreConfig;
exports.SubscriptionManager = SubscriptionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0c3RvcmVfdjEuanMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9pbmRleENvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9zdG9yZUNvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9kYkNvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9kYkNvbmZpZ3VyZXIuanMiLCIuLi8uLi9zcmMvb2JqZWN0c3RvcmUvc3Vic2NyaXB0aW9uTWFuYWdlci5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9kYk1hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIEluZGV4Q29uZmlnIHtcblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFxuICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdW5pcXVlIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIHBhdGgsIHVuaXF1ZSkge1xuXG4gICAgICAgIC8qKiBAdHlwZSB7U3RyaW5nfSAqL1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuXG4gICAgICAgIC8qKiBAdHlwZSB7U3RyaW5nfSAqL1xuICAgICAgICB0aGlzLnBhdGggPSBwYXRoO1xuXG4gICAgICAgIC8qKiBAdHlwZSB7Qm9vbGVhbn0gKi9cbiAgICAgICAgdGhpcy51bmlxdWUgPSB1bmlxdWU7XG4gICAgfVxuXG59IiwiaW1wb3J0IHsgTGlzdCB9IGZyb20gXCJjb3JldXRpbF92MVwiO1xuaW1wb3J0IHsgSW5kZXhDb25maWcgfSBmcm9tIFwiLi9pbmRleENvbmZpZy5qc1wiO1xuXG5leHBvcnQgY2xhc3MgU3RvcmVDb25maWcge1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtTdHJpbmd9ICovXG4gICAgICAgIHRoaXMuc3RvcmVOYW1lID0gbnVsbDtcblxuICAgICAgICAvKiogQHR5cGUge1N0cmluZ30gKi9cbiAgICAgICAgdGhpcy5rZXlQYXRoID0gbnVsbDtcblxuICAgICAgICAvKiogQHR5cGUge0xpc3Q8SW5kZXhDb25maWc+fSAqL1xuICAgICAgICB0aGlzLmluZGV4TGlzdCA9IG5ldyBMaXN0KCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lIFxuICAgICAqL1xuICAgIHdpdGhTdG9yZU5hbWUoc3RvcmVOYW1lKSB7XG4gICAgICAgIHRoaXMuc3RvcmVOYW1lID0gc3RvcmVOYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lIFxuICAgICAqL1xuICAgIHdpdGhLZXlQYXRoKGtleVBhdGgpIHtcbiAgICAgICAgdGhpcy5rZXlQYXRoID0ga2V5UGF0aDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHN0b3JlTmFtZSBcbiAgICAgKi9cbiAgICB3aXRoSW5kZXgobmFtZSwgcGF0aCwgdW5pcXVlKSB7XG4gICAgICAgIHRoaXMuaW5kZXhMaXN0LmFkZChuZXcgSW5kZXhDb25maWcobmFtZSwgcGF0aCwgdW5pcXVlKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufSIsImltcG9ydCB7IExpc3QgfSBmcm9tIFwiY29yZXV0aWxfdjFcIjtcbmltcG9ydCB7IFN0b3JlQ29uZmlnIH0gZnJvbSBcIi4vc3RvcmVDb25maWdcIjtcblxuZXhwb3J0IGNsYXNzIERiQ29uZmlnIHtcblxuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtOdW1iZXJ9ICovXG4gICAgICAgIHRoaXMudmVyc2lvbiA9IDE7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtMaXN0PFN0b3JlQ29uZmlnfSAqL1xuICAgICAgICB0aGlzLnN0b3JlQ29uZmlnTGlzdCA9IG5ldyBMaXN0KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtOdW1iZXJ9IHZlcnNpb24gXG4gICAgICovXG4gICAgIHdpdGhWZXJzaW9uKHZlcnNpb24pIHtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdG9yZUNvbmZpZ30gc3RvcmVDb25maWcgXG4gICAgICovXG4gICAgd2l0aFN0b3JlQ29uZmlnKHN0b3JlQ29uZmlnKSB7IFxuICAgICAgICB0aGlzLnN0b3JlQ29uZmlnTGlzdC5hZGQoc3RvcmVDb25maWcpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cblxufSIsImltcG9ydCB7IExvZ2dlciB9IGZyb20gXCJjb3JldXRpbF92MVwiO1xuaW1wb3J0IHsgRGJDb25maWcgfSBmcm9tIFwiLi9kYkNvbmZpZ1wiO1xuXG5jb25zdCBMT0cgPSBuZXcgTG9nZ2VyKFwiU3RvcmVDb25maWdcIik7XG5cbmV4cG9ydCBjbGFzcyBEQkNvbmZpZ3VyZXIge1xuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtEYkNvbmZpZ30gZGJDb25maWcgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoZGJDb25maWcpIHtcbiAgICAgICAgdGhpcy5kYkNvbmZpZyA9IGRiQ29uZmlnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7SURCVmVyc2lvbkNoYW5nZUV2ZW50fSB2ZXJzaW9uQ2hhbmdlRXZlbnQgXG4gICAgICovXG4gICAgdXBkZ3JhZGUodmVyc2lvbkNoYW5nZUV2ZW50KSB7XG4gICAgICAgIExPRy5pbmZvKFwiVXBncmFkZSBuZWVkZWRcIik7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtJREJEYXRhYmFzZX0gKi9cbiAgICAgICAgY29uc3QgZGIgPSB2ZXJzaW9uQ2hhbmdlRXZlbnQudGFyZ2V0LnJlc3VsdDtcblxuICAgICAgICB0aGlzLmRiQ29uZmlnLnN0b3JlQ29uZmlnTGlzdC5mb3JFYWNoKChzdG9yZUNvbmZpZykgPT4ge1xuXG4gICAgICAgICAgICAvLyBDbGVhciB0aGUgb2xkXG4gICAgICAgICAgICBpZiAoZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZUNvbmZpZy5zdG9yZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgZGIuZGVsZXRlT2JqZWN0U3RvcmUoc3RvcmVDb25maWcuc3RvcmVOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbmV3XG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IGRiLmNyZWF0ZU9iamVjdFN0b3JlKFxuICAgICAgICAgICAgICAgIHN0b3JlQ29uZmlnLnN0b3JlTmFtZSwgXG4gICAgICAgICAgICAgICAgeyBrZXlQYXRoOiBzdG9yZUNvbmZpZy5rZXlQYXRoIH1cbiAgICAgICAgICAgICk7XG4gICAgXG4gICAgICAgICAgICBzdG9yZUNvbmZpZy5pbmRleExpc3QuZm9yRWFjaCgoaW5kZXhDb25maWcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHN0b3JlLmNyZWF0ZUluZGV4KFxuICAgICAgICAgICAgICAgICAgICBpbmRleENvbmZpZy5uYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhDb25maWcucGF0aCwgXG4gICAgICAgICAgICAgICAgICAgIHt1bmlxdWU6IGluZGV4Q29uZmlnLnVuaXF1ZX1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSIsImltcG9ydCB7IExpc3QsIE9iamVjdEZ1bmN0aW9uIH0gZnJvbSBcImNvcmV1dGlsX3YxXCI7XG5cbmV4cG9ydCBjbGFzcyBTdWJzY3JpcHRpb25NYW5hZ2VyIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnB1dFN1YnNjcmliZXJzID0gbmV3IExpc3QoKTtcbiAgICAgICAgdGhpcy5kZWxldGVTdWJzY3JpYmVycyA9IG5ldyBMaXN0KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlcnMgYXJlIHdlYWtseSByZWZlcmVuY2VkLiBLZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBcbiAgICAgKiBpbnN0YW5jZSBvZiB0aGUgT2JqZWN0RnVuY3Rpb24gdG8gZW5zdXJlIGl0IGlzIG5vdCBhdXRvbWF0aWNhbGx5XG4gICAgICogcmVtb3ZlZC5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge09iamVjdEZ1bmN0aW9ufSBwdXRTdWJzY3JpYmVyIFxuICAgICAqL1xuICAgIHN1YnNjcmliZVB1dChwdXRTdWJzY3JpYmVyKSB7XG4gICAgICAgIGlmIChwdXRTdWJzY3JpYmVyIGluc3RhbmNlb2YgT2JqZWN0RnVuY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMucHV0U3Vic2NyaWJlcnMuYWRkKG5ldyBXZWFrUmVmKHB1dFN1YnNjcmliZXIpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXJzIGFyZSB3ZWFrbHkgcmVmZXJlbmNlZC4gS2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgXG4gICAgICogaW5zdGFuY2Ugb2YgdGhlIE9iamVjdEZ1bmN0aW9uIHRvIGVuc3VyZSBpdCBpcyBub3QgYXV0b21hdGljYWxseVxuICAgICAqIHJlbW92ZWQuXG4gICAgICogXG4gICAgICogQHBhcmFtIHtPYmplY3RGdW5jdGlvbn0gZGVsZXRlU3Vic2NyaWJlciBcbiAgICAgKi9cbiAgICAgc3Vic2NyaWJlRGVsZXRlKGRlbGV0ZVN1YnNjcmliZXIpIHtcbiAgICAgICAgaWYgKGRlbGV0ZVN1YnNjcmliZXIgaW5zdGFuY2VvZiBPYmplY3RGdW5jdGlvbikge1xuICAgICAgICAgICAgdGhpcy5kZWxldGVTdWJzY3JpYmVycy5hZGQobmV3IFdlYWtSZWYoZGVsZXRlU3Vic2NyaWJlcikpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbm90aWZ5UHV0KGVudGl0eSkge1xuICAgICAgICBsZXQgdG9SZW1vdmVBcnJheSA9IFtdO1xuICAgICAgICB0aGlzLnB1dFN1YnNjcmliZXJzLmZvckVhY2goKHdlYWtSZWZTdWJzY3JpYmVyLCBwYXJlbnQpID0+IHtcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0RnVuY3Rpb259ICovXG4gICAgICAgICAgICBsZXQgc3Vic2NyaWJlciA9IHdlYWtSZWZTdWJzY3JpYmVyLmRlcmVmKCk7XG4gICAgICAgICAgICBpZiAoIXN1YnNjcmliZXIpIHtcbiAgICAgICAgICAgICAgICB0b1JlbW92ZUFycmF5LnB1c2god2Vha1JlZlN1YnNjcmliZXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdWJzY3JpYmVyLmNhbGwoZW50aXR5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgbmV3IExpc3QodG9SZW1vdmVBcnJheSkuZm9yRWFjaCgodG9SZW1vdmUsIHBhcmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wdXRTdWJzY3JpYmVycy5yZW1vdmUodG9SZW1vdmUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBub3RpZnlEZWxldGUoa2V5KSB7XG4gICAgICAgIGxldCB0b1JlbW92ZUFycmF5ID0gW107XG4gICAgICAgIHRoaXMuZGVsZXRlU3Vic2NyaWJlcnMuZm9yRWFjaCgod2Vha1JlZlN1YnNjcmliZXIsIHBhcmVudCkgPT4ge1xuICAgICAgICAgICAgLyoqIEB0eXBlIHtPYmplY3RGdW5jdGlvbn0gKi9cbiAgICAgICAgICAgIGxldCBzdWJzY3JpYmVyID0gd2Vha1JlZlN1YnNjcmliZXIuZGVyZWYoKTtcbiAgICAgICAgICAgIGlmICghc3Vic2NyaWJlcikge1xuICAgICAgICAgICAgICAgIHRvUmVtb3ZlQXJyYXkucHVzaCh3ZWFrUmVmU3Vic2NyaWJlcik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN1YnNjcmliZXIuY2FsbChrZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0sIHRoaXMpO1xuICAgICAgICBuZXcgTGlzdCh0b1JlbW92ZUFycmF5KS5mb3JFYWNoKCh0b1JlbW92ZSwgcGFyZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRlbGV0ZVN1YnNjcmliZXJzLnJlbW92ZSh0b1JlbW92ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSIsImltcG9ydCB7IE1hcCwgT2JqZWN0RnVuY3Rpb24gfSBmcm9tIFwiY29yZXV0aWxfdjFcIjtcbmltcG9ydCB7IENvbnRhaW5lckRhdGFiYXNlU3RvcmFnZSB9IGZyb20gXCJjb250YWluZXJicmlkZ2VfdjFcIjtcbmltcG9ydCB7IERCQ29uZmlndXJlciB9IGZyb20gXCIuL2RiQ29uZmlndXJlci5qc1wiO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uTWFuYWdlciB9IGZyb20gXCIuL3N1YnNjcmlwdGlvbk1hbmFnZXIuanNcIjtcbmltcG9ydCB7IERiQ29uZmlnIH0gZnJvbSBcIi4vZGJDb25maWcuanNcIjtcblxuLyoqXG4gKiBNYW5hZ2VzIGEgZGF0YWJhc2Ugd2l0aCAwIHRvIG1hbnkgc3RvcmVzXG4gKi9cbmV4cG9ydCBjbGFzcyBEQk1hbmFnZXIge1xuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtJREJEYXRhYmFzZX0gZGIgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoZGIpIHtcbiAgICAgICAgXG4gICAgICAgIC8qKiBAdHlwZSB7SURCRGF0YWJhc2V9ICovXG4gICAgICAgIHRoaXMuZGIgPSBkYjtcblxuICAgICAgICAvKiogQHR5cGUge01hcDxTdWJzY3JpcHRpb25NYW5hZ2VyPn0gKi9cbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwID0gbmV3IE1hcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBkYk5hbWUgXG4gICAgICogQHBhcmFtIHtEYkNvbmZpZ30gZGJDb25maWcgXG4gICAgICogQHJldHVybiB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBzdGF0aWMgZnJvbVN0b3JlKGRiTmFtZSwgZGJDb25maWcpIHtcbiAgICAgICAgY29uc3QgZGJDb25maWd1cmVyID0gbmV3IERCQ29uZmlndXJlcihkYkNvbmZpZyk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcGVuUmVxdWVzdCA9IENvbnRhaW5lckRhdGFiYXNlU3RvcmFnZS5vcGVuKGRiTmFtZSwgZGJDb25maWcudmVyc2lvbik7XG4gICAgICAgICAgICBvcGVuUmVxdWVzdC5vbmVycm9yID0gKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgTE9HLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3BlblJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IERCTWFuYWdlcihvcGVuUmVxdWVzdC5yZXN1bHQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wZW5SZXF1ZXN0Lm9udXBncmFkZW5lZWRlZCA9IGRiQ29uZmlndXJlci51cGRncmFkZS5iaW5kKGRiQ29uZmlndXJlcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEByZXR1cm5zIHtPYmplY3R9XG4gICAgICovXG4gICAgc3RhdGljIG1hcEVudGl0eSh0eXBlLCBkYXRhT2JqZWN0KSB7XG4gICAgICAgIGlmIChkYXRhT2JqZWN0KSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdHlwZSwgZGF0YU9iamVjdCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lIFxuICAgICAqIEBwYXJhbSB7SURCVHJhbnNhY3Rpb25Nb2RlfSB0cmFuc2FjdGlvblR5cGUgcmVhZHdyaXRlXG4gICAgICogQHJldHVybnMge0lEQlRyYW5zYWN0aW9ufVxuICAgICAqL1xuICAgIHRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uVHlwZSwgc3RvcmVOYW1lKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnRyYW5zYWN0aW9uKHN0b3JlTmFtZSwgdHJhbnNhY3Rpb25UeXBlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge0lEQlRyYW5zYWN0aW9ufSB0cmFuc2FjdGlvblxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdG9yZU5hbWVcbiAgICAgKiBAcmV0dXJucyB7SURCT2plY3RTdG9yZX1cbiAgICAgKi9cbiAgICBvYmplY3RTdG9yZSh0cmFuc2FjdGlvbiwgc3RvcmVOYW1lKSB7XG4gICAgICAgIHJldHVybiB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7SURCT2JqZWN0U3RvcmV9IG9iamVjdFN0b3JlIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBpbmRleE5hbWVcbiAgICAgKiBAcmV0dXJucyB7SURCSW5kZXh9XG4gICAgICovXG4gICAgaW5kZXgob2JqZWN0U3RvcmUsIGluZGV4TmFtZSkge1xuICAgICAgICByZXR1cm4gb2JqZWN0U3RvcmUuaW5kZXgoaW5kZXhOYW1lKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge09iamVjdH0gZW50aXR5XG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHN0b3JlTmFtZVxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9XG4gICAgICovXG4gICAgcHV0RW50aXR5KGVudGl0eSwgc3RvcmVOYW1lKSB7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy50cmFuc2FjdGlvbihcInJlYWR3cml0ZVwiLCBzdG9yZU5hbWUpO1xuICAgICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG4gICAgICAgIGNvbnN0IHB1dFJlcXVlc3QgPSBzdG9yZS5wdXQoZW50aXR5KTtcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBwdXRSZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHsgY29udGV4dC5ub3RpZnlQdXQoZW50aXR5LCBzdG9yZU5hbWUpOyByZXNvbHZlKGVudGl0eSk7IH07XG4gICAgICAgICAgICBwdXRSZXF1ZXN0Lm9uZXJyb3IgPSAoZXJyb3IpID0+IHsgcmVqZWN0KGVycm9yKTsgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICAgICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lXG4gICAgICogQHBhcmFtIHtDbGFzc30gdHlwZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIGdldEVudGl0eShrZXksIHR5cGUsIHN0b3JlTmFtZSkge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMudHJhbnNhY3Rpb24oXCJyZWFkb25seVwiLCBzdG9yZU5hbWUpO1xuICAgICAgICBjb25zdCB1c2VyU3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuICAgICAgICBjb25zdCBnZXRSZXF1ZXN0ID0gdXNlclN0b3JlLmdldChrZXkpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgZ2V0UmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7IHJlc29sdmUoREJNYW5hZ2VyLm1hcEVudGl0eSh0eXBlLCBnZXRSZXF1ZXN0LnJlc3VsdCkpOyB9O1xuICAgICAgICAgICAgZ2V0UmVxdWVzdC5vbmVycm9yID0gKGVycm9yKSA9PiB7IHJlamVjdChlcnJvcik7IH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHN0b3JlTmFtZVxuICAgICAqIEByZXR1cm5zIHtQcm9taXNlfVxuICAgICAqL1xuICAgIGRlbGV0ZUVudGl0eShrZXksIHN0b3JlTmFtZSkge1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMudHJhbnNhY3Rpb24oXCJyZWFkd3JpdGVcIiwgc3RvcmVOYW1lKTtcbiAgICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZShzdG9yZU5hbWUpO1xuICAgICAgICBjb25zdCBkZWxldGVSZXF1ZXN0ID0gc3RvcmUuZGVsZXRlKGtleSk7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgZGVsZXRlUmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiB7ICBjb250ZXh0Lm5vdGlmeURlbGV0ZShrZXksIHN0b3JlTmFtZSk7IHJlc29sdmUoZGVsZXRlUmVxdWVzdC5yZXN1bHQpOyB9O1xuICAgICAgICAgICAgZGVsZXRlUmVxdWVzdC5vbmVycm9yID0gKGVycm9yKSA9PiB7cmVqZWN0KGVycm9yKTsgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbm90aWZ5RGVsZXRlKGtleSwgc3RvcmVOYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuY29udGFpbnMoc3RvcmVOYW1lKSkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmdldChzdG9yZU5hbWUpLm5vdGlmeURlbGV0ZShrZXkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgbm90aWZ5UHV0KGVudGl0eSwgc3RvcmVOYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuY29udGFpbnMoc3RvcmVOYW1lKSkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmdldChzdG9yZU5hbWUpLm5vdGlmeVB1dChlbnRpdHkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlcnMgYXJlIHdlYWtseSByZWZlcmVuY2VkLiBLZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBcbiAgICAgKiBpbnN0YW5jZSBvZiB0aGUgT2JqZWN0RnVuY3Rpb24gdG8gZW5zdXJlIGl0IGlzIG5vdCBhdXRvbWF0aWNhbGx5XG4gICAgICogcmVtb3ZlZC5cbiAgICAgKiBcbiAgICAgKiBAdHlwZSB7U3RyaW5nfSBzdG9yZU5hbWVcbiAgICAgKiBAdHlwZSB7T2JqZWN0RnVuY3Rpb259IHB1dE9iamVjdEZ1bmN0aW9uXG4gICAgICovXG4gICAgc3Vic2NyaWJlUHV0KHN0b3JlTmFtZSwgcHV0T2JqZWN0RnVuY3Rpb24pIHtcbiAgICAgICAgaWYgKCF0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuY29udGFpbnMoc3RvcmVOYW1lKSkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLnNldChzdG9yZU5hbWUsIG5ldyBTdWJzY3JpcHRpb25NYW5hZ2VyKCkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5nZXQoc3RvcmVOYW1lKS5zdWJzY3JpYmVQdXQocHV0T2JqZWN0RnVuY3Rpb24pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXJzIGFyZSB3ZWFrbHkgcmVmZXJlbmNlZC4gS2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgXG4gICAgICogaW5zdGFuY2Ugb2YgdGhlIE9iamVjdEZ1bmN0aW9uIHRvIGVuc3VyZSBpdCBpcyBub3QgYXV0b21hdGljYWxseVxuICAgICAqIHJlbW92ZWQuXG4gICAgICogXG4gICAgICogQHR5cGUge1N0cmluZ30gc3RvcmVOYW1lXG4gICAgICogQHR5cGUge09iamVjdEZ1bmN0aW9ufSBkZWxldGVPYmplY3RGdW5jdGlvblxuICAgICAqL1xuICAgIHN1YnNjcmliZURlbGV0ZShzdG9yZU5hbWUsIGRlbGV0ZU9iamVjdEZ1bmN0aW9uKSB7XG4gICAgICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmNvbnRhaW5zKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5zZXQoc3RvcmVOYW1lLCBuZXcgU3Vic2NyaXB0aW9uTWFuYWdlcigpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuZ2V0KHN0b3JlTmFtZSkuc3Vic2NyaWJlRGVsZXRlKGRlbGV0ZU9iamVjdEZ1bmN0aW9uKTtcbiAgICB9XG5cbn0iXSwibmFtZXMiOlsiTGlzdCIsIkxPRyIsIkxvZ2dlciIsIk9iamVjdEZ1bmN0aW9uIiwiTWFwIiwiQ29udGFpbmVyRGF0YWJhc2VTdG9yYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQU8sTUFBTSxXQUFXLENBQUM7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUNwQztB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
