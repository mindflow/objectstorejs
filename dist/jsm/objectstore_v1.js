import { List, Logger, ObjectFunction, Map } from './coreutil_v1.js';
import { ContainerDatabaseStorage } from './containerbridge_v1.js';

class IndexConfig {

    /**
     * 
     * @param {String} name 
     * @param {String} path 
     * @param {Boolean} unique 
     */
    constructor(name, path, unique) {

        /** @type {String} */
        this.name = name;

        /** @type {String} */
        this.path = path;

        /** @type {Boolean} */
        this.unique = unique;
    }

}

class StoreConfig {

    constructor() {

        /** @type {String} */
        this.storeName = null;

        /** @type {String} */
        this.keyPath = null;

        /** @type {List<IndexConfig>} */
        this.indexList = new List();

    }

    /**
     * 
     * @param {String} storeName 
     */
    withStoreName(storeName) {
        this.storeName = storeName;
        return this;
    }

    /**
     * 
     * @param {String} storeName 
     */
    withKeyPath(keyPath) {
        this.keyPath = keyPath;
        return this;
    }

    /**
     * 
     * @param {String} storeName 
     */
    withIndex(name, path, unique) {
        this.indexList.add(new IndexConfig(name, path, unique));
        return this;
    }

}

class DbConfig {


    constructor() {

        /** @type {Number} */
        this.version = 1;

        /** @type {List<StoreConfig} */
        this.storeConfigList = new List();
    }

    /**
     * 
     * @param {Number} version 
     */
     withVersion(version) {
        this.version = version;
        return this;
    }

    /**
     * 
     * @param {StoreConfig} storeConfig 
     */
    withStoreConfig(storeConfig) { 
        this.storeConfigList.add(storeConfig);
        return this;
    }


}

const LOG$1 = new Logger("StoreConfig");

class DBConfigurer {

    /**
     * 
     * @param {DbConfig} dbConfig 
     */
    constructor(dbConfig) {
        this.dbConfig = dbConfig;
    }

    /**
     * 
     * @param {IDBVersionChangeEvent} versionChangeEvent 
     */
    updgrade(versionChangeEvent) {
        LOG$1.info("Upgrade needed");

        /** @type {IDBDatabase} */
        const db = versionChangeEvent.target.result;

        this.dbConfig.storeConfigList.forEach((storeConfig) => {

            // Clear the old
            if (db.objectStoreNames.contains(storeConfig.storeName)) {
                db.deleteObjectStore(storeConfig.storeName);
            }
    
            // Create the new
            const store = db.createObjectStore(
                storeConfig.storeName, 
                { keyPath: storeConfig.keyPath }
            );
    
            storeConfig.indexList.forEach((indexConfig) => {
                const index = store.createIndex(
                    indexConfig.name, 
                    indexConfig.path, 
                    {unique: indexConfig.unique}
                );
                return true;
            });

            return true;
        });
    }

}

class SubscriptionManager {

    constructor() {
        this.putSubscribers = new List();
        this.deleteSubscribers = new List();
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @param {ObjectFunction} putSubscriber 
     * @param {ObjectFunction} deleteSubscriber 
     */
    subscribe(putSubscriber, deleteSubscriber) {
        if (putSubscriber instanceof ObjectFunction) {
            this.putSubscribers.add(new WeakRef(putSubscriber));
        }
        if (deleteSubscriber instanceof ObjectFunction) {
            this.deleteSubscribers.add(new WeakRef(deleteSubscriber));
        }
    }

    notifyPut(entity) {
        let toRemoveArray = [];
        this.putSubscribers.forEach((weakRefSubscriber, parent) => {
            /** @type {ObjectFunction} */
            let subscriber = weakRefSubscriber.deref();
            if (!subscriber) {
                toRemoveArray.push(weakRefSubscriber);
            } else {
                subscriber.call(entity);
            }
            return true;
        }, this);
        new List(toRemoveArray).forEach((toRemove, parent) => {
            this.putSubscribers.remove(toRemove);
        });
    }

    notifyDelete(key) {
        let toRemoveArray = [];
        this.deleteSubscribers.forEach((weakRefSubscriber, parent) => {
            /** @type {ObjectFunction} */
            let subscriber = weakRefSubscriber.deref();
            if (!subscriber) {
                toRemoveArray.push(weakRefSubscriber);
            } else {
                subscriber.call(key);
            }
            return true;
        }, this);
        new List(toRemoveArray).forEach((toRemove, parent) => {
            this.deleteSubscribers.remove(toRemove);
        });
    }

}

/**
 * Manages a database with 0 to many stores
 */
class DBManager {

    /**
     * 
     * @param {IDBDatabase} db 
     */
    constructor(db) {
        
        /** @type {IDBDatabase} */
        this.db = db;

        /** @type {Map} */
        this.subscriptionManagerMap = new Map();
    }

    /**
     * 
     * @param {String} dbName 
     * @param {DbConfig} dbConfig 
     * @return {Promise}
     */
    static fromStore(dbName, dbConfig) {
        const dbConfigurer = new DBConfigurer(dbConfig);
        return new Promise((resolve, reject) => {
            const openRequest = ContainerDatabaseStorage.open(dbName, dbConfig.version);
            openRequest.onerror = (error) => {
                LOG.error(error);
                reject(error);
            };
            openRequest.onsuccess = () => {
                resolve(new DBManager(openRequest.result));
            };
            openRequest.onupgradeneeded = dbConfigurer.updgrade.bind(dbConfigurer);
        });
    }

    /**
     * @returns {Object}
     */
    static mapEntity(type, dataObject) {
        if (dataObject) {
            return Object.assign(new type, dataObject);
        }
        return null;
    }


    /**
     * 
     * @param {String} storeName 
     * @param {IDBTransactionMode} transactionType readwrite
     * @returns {IDBTransaction}
     */
    transaction(transactionType, storeName) {
        return this.db.transaction(storeName, transactionType);
    }

    /**
     * 
     * @param {IDBTransaction} transaction
     * @param {String} storeName
     * @returns {IDBOjectStore}
     */
    objectStore(transaction, storeName) {
        return transaction.objectStore(storeName);
    }

    /**
     * 
     * @param {IDBObjectStore} objectStore 
     * @param {String} indexName
     * @returns {IDBIndex}
     */
    index(objectStore, indexName) {
        return objectStore.index(indexName);
    }

    /**
     * @param {Object} entity
     * @param {String} storeName
     * @param {String} transactionType
     * @return {Promise}
     */
    putEntity(entity, storeName) {
        const transaction = this.transaction("readwrite", storeName);
        const store = transaction.objectStore(storeName);
        const putRequest = store.put(entity);
        const context = this;
        return new Promise((resolve, reject) => {
            putRequest.onsuccess = () => { context.notifyPut(entity, storeName); resolve(entity); };
            putRequest.onerror = (error) => { reject(error); };
        });
    }


        /**
     * 
     * @param {String} key 
     * @param {String} storeName
     * @param {Class} type
     * @returns {Promise}
     */
    getEntity(key, type, storeName) {
        const transaction = this.transaction("readonly", storeName);
        const userStore = transaction.objectStore(storeName);
        const getRequest = userStore.get(key);
        return new Promise((resolve, reject) => {
            getRequest.onsuccess = () => { resolve(DBManager.mapEntity(type, getRequest.result)); };
            getRequest.onerror = (error) => { reject(error); };
        });
    }

    /**
     * 
     * @param {String} key 
     * @returns {Promise}
     */
    deleteEntity(key, storeName) {
        const transaction = this.transaction("readwrite", storeName);
        const store = transaction.objectStore(storeName);
        const deleteRequest = store.delete(key);
        const context = this;
        return new Promise((resolve, reject) => {
            deleteRequest.onsuccess = () => {  context.notifyDelete(key, storeName); resolve(deleteRequest.result); };
            deleteRequest.onerror = (error) => {reject(error); };
        });
    }

    notifyDelete(key, storeName) {
        if (this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.get(storeName).notifyDelete(key);
        }
    }

    notifyPut(entity, storeName) {
        if (this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.get(storeName).notifyPut(entity);
        }
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @type {String} storeName
     * @type {ObjectFunction} objectFunction
     */
    subscribePut(storeName, objectFunction) {
        if (!this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.set(storeName, new SubscriptionManager());
        }
        this.subscriptionManagerMap.get(storeName).subscribe(objectFunction);
    }

    /**
     * Subscribers are weakly referenced. Keep a reference to the 
     * instance of the ObjectFunction to ensure it is not automatically
     * removed.
     * 
     * @type {String} storeName
     * @type {ObjectFunction} putObjectFunction
     * @type {ObjectFunction} deleteObjectFunction
     */
    subscribe(putObjectFunction, deleteObjectFunction, storeName) {
        if (!this.subscriptionManagerMap.contains(storeName)) {
            this.subscriptionManagerMap.set(storeName, new SubscriptionManager());
        }
        this.subscriptionManagerMap.get(storeName).subscribe(putObjectFunction, deleteObjectFunction);
    }

}

export { DBConfigurer, DBManager, DbConfig, IndexConfig, StoreConfig, SubscriptionManager };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0c3RvcmVfdjEuanMiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9pbmRleENvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9zdG9yZUNvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9EYkNvbmZpZy5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9kYkNvbmZpZ3VyZXIuanMiLCIuLi8uLi9zcmMvb2JqZWN0c3RvcmUvc3Vic2NyaXB0aW9uTWFuYWdlci5qcyIsIi4uLy4uL3NyYy9vYmplY3RzdG9yZS9kYk1hbmFnZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIEluZGV4Q29uZmlnIHtcblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIFxuICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gdW5pcXVlIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWUsIHBhdGgsIHVuaXF1ZSkge1xuXG4gICAgICAgIC8qKiBAdHlwZSB7U3RyaW5nfSAqL1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuXG4gICAgICAgIC8qKiBAdHlwZSB7U3RyaW5nfSAqL1xuICAgICAgICB0aGlzLnBhdGggPSBwYXRoO1xuXG4gICAgICAgIC8qKiBAdHlwZSB7Qm9vbGVhbn0gKi9cbiAgICAgICAgdGhpcy51bmlxdWUgPSB1bmlxdWU7XG4gICAgfVxuXG59IiwiaW1wb3J0IHsgTGlzdCB9IGZyb20gXCJjb3JldXRpbF92MVwiO1xuaW1wb3J0IHsgSW5kZXhDb25maWcgfSBmcm9tIFwiLi9pbmRleENvbmZpZy5qc1wiO1xuXG5leHBvcnQgY2xhc3MgU3RvcmVDb25maWcge1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtTdHJpbmd9ICovXG4gICAgICAgIHRoaXMuc3RvcmVOYW1lID0gbnVsbDtcblxuICAgICAgICAvKiogQHR5cGUge1N0cmluZ30gKi9cbiAgICAgICAgdGhpcy5rZXlQYXRoID0gbnVsbDtcblxuICAgICAgICAvKiogQHR5cGUge0xpc3Q8SW5kZXhDb25maWc+fSAqL1xuICAgICAgICB0aGlzLmluZGV4TGlzdCA9IG5ldyBMaXN0KCk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lIFxuICAgICAqL1xuICAgIHdpdGhTdG9yZU5hbWUoc3RvcmVOYW1lKSB7XG4gICAgICAgIHRoaXMuc3RvcmVOYW1lID0gc3RvcmVOYW1lO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lIFxuICAgICAqL1xuICAgIHdpdGhLZXlQYXRoKGtleVBhdGgpIHtcbiAgICAgICAgdGhpcy5rZXlQYXRoID0ga2V5UGF0aDtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHN0b3JlTmFtZSBcbiAgICAgKi9cbiAgICB3aXRoSW5kZXgobmFtZSwgcGF0aCwgdW5pcXVlKSB7XG4gICAgICAgIHRoaXMuaW5kZXhMaXN0LmFkZChuZXcgSW5kZXhDb25maWcobmFtZSwgcGF0aCwgdW5pcXVlKSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxufSIsImltcG9ydCB7IExpc3QgfSBmcm9tIFwiY29yZXV0aWxfdjFcIjtcbmltcG9ydCB7IFN0b3JlQ29uZmlnIH0gZnJvbSBcIi4vc3RvcmVDb25maWdcIjtcblxuZXhwb3J0IGNsYXNzIERiQ29uZmlnIHtcblxuXG4gICAgY29uc3RydWN0b3IoKSB7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtOdW1iZXJ9ICovXG4gICAgICAgIHRoaXMudmVyc2lvbiA9IDE7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtMaXN0PFN0b3JlQ29uZmlnfSAqL1xuICAgICAgICB0aGlzLnN0b3JlQ29uZmlnTGlzdCA9IG5ldyBMaXN0KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtOdW1iZXJ9IHZlcnNpb24gXG4gICAgICovXG4gICAgIHdpdGhWZXJzaW9uKHZlcnNpb24pIHtcbiAgICAgICAgdGhpcy52ZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdG9yZUNvbmZpZ30gc3RvcmVDb25maWcgXG4gICAgICovXG4gICAgd2l0aFN0b3JlQ29uZmlnKHN0b3JlQ29uZmlnKSB7IFxuICAgICAgICB0aGlzLnN0b3JlQ29uZmlnTGlzdC5hZGQoc3RvcmVDb25maWcpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cblxufSIsImltcG9ydCB7IExvZ2dlciB9IGZyb20gXCJjb3JldXRpbF92MVwiO1xuaW1wb3J0IHsgRGJDb25maWcgfSBmcm9tIFwiLi9EYkNvbmZpZ1wiO1xuXG5jb25zdCBMT0cgPSBuZXcgTG9nZ2VyKFwiU3RvcmVDb25maWdcIik7XG5cbmV4cG9ydCBjbGFzcyBEQkNvbmZpZ3VyZXIge1xuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtEYkNvbmZpZ30gZGJDb25maWcgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IoZGJDb25maWcpIHtcbiAgICAgICAgdGhpcy5kYkNvbmZpZyA9IGRiQ29uZmlnO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7SURCVmVyc2lvbkNoYW5nZUV2ZW50fSB2ZXJzaW9uQ2hhbmdlRXZlbnQgXG4gICAgICovXG4gICAgdXBkZ3JhZGUodmVyc2lvbkNoYW5nZUV2ZW50KSB7XG4gICAgICAgIExPRy5pbmZvKFwiVXBncmFkZSBuZWVkZWRcIik7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtJREJEYXRhYmFzZX0gKi9cbiAgICAgICAgY29uc3QgZGIgPSB2ZXJzaW9uQ2hhbmdlRXZlbnQudGFyZ2V0LnJlc3VsdDtcblxuICAgICAgICB0aGlzLmRiQ29uZmlnLnN0b3JlQ29uZmlnTGlzdC5mb3JFYWNoKChzdG9yZUNvbmZpZykgPT4ge1xuXG4gICAgICAgICAgICAvLyBDbGVhciB0aGUgb2xkXG4gICAgICAgICAgICBpZiAoZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhzdG9yZUNvbmZpZy5zdG9yZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgZGIuZGVsZXRlT2JqZWN0U3RvcmUoc3RvcmVDb25maWcuc3RvcmVOYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbmV3XG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IGRiLmNyZWF0ZU9iamVjdFN0b3JlKFxuICAgICAgICAgICAgICAgIHN0b3JlQ29uZmlnLnN0b3JlTmFtZSwgXG4gICAgICAgICAgICAgICAgeyBrZXlQYXRoOiBzdG9yZUNvbmZpZy5rZXlQYXRoIH1cbiAgICAgICAgICAgICk7XG4gICAgXG4gICAgICAgICAgICBzdG9yZUNvbmZpZy5pbmRleExpc3QuZm9yRWFjaCgoaW5kZXhDb25maWcpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHN0b3JlLmNyZWF0ZUluZGV4KFxuICAgICAgICAgICAgICAgICAgICBpbmRleENvbmZpZy5uYW1lLCBcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhDb25maWcucGF0aCwgXG4gICAgICAgICAgICAgICAgICAgIHt1bmlxdWU6IGluZGV4Q29uZmlnLnVuaXF1ZX1cbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSIsImltcG9ydCB7IExpc3QsIE9iamVjdEZ1bmN0aW9uIH0gZnJvbSBcImNvcmV1dGlsX3YxXCI7XG5cbmV4cG9ydCBjbGFzcyBTdWJzY3JpcHRpb25NYW5hZ2VyIHtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnB1dFN1YnNjcmliZXJzID0gbmV3IExpc3QoKTtcbiAgICAgICAgdGhpcy5kZWxldGVTdWJzY3JpYmVycyA9IG5ldyBMaXN0KCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3Vic2NyaWJlcnMgYXJlIHdlYWtseSByZWZlcmVuY2VkLiBLZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBcbiAgICAgKiBpbnN0YW5jZSBvZiB0aGUgT2JqZWN0RnVuY3Rpb24gdG8gZW5zdXJlIGl0IGlzIG5vdCBhdXRvbWF0aWNhbGx5XG4gICAgICogcmVtb3ZlZC5cbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge09iamVjdEZ1bmN0aW9ufSBwdXRTdWJzY3JpYmVyIFxuICAgICAqIEBwYXJhbSB7T2JqZWN0RnVuY3Rpb259IGRlbGV0ZVN1YnNjcmliZXIgXG4gICAgICovXG4gICAgc3Vic2NyaWJlKHB1dFN1YnNjcmliZXIsIGRlbGV0ZVN1YnNjcmliZXIpIHtcbiAgICAgICAgaWYgKHB1dFN1YnNjcmliZXIgaW5zdGFuY2VvZiBPYmplY3RGdW5jdGlvbikge1xuICAgICAgICAgICAgdGhpcy5wdXRTdWJzY3JpYmVycy5hZGQobmV3IFdlYWtSZWYocHV0U3Vic2NyaWJlcikpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkZWxldGVTdWJzY3JpYmVyIGluc3RhbmNlb2YgT2JqZWN0RnVuY3Rpb24pIHtcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlU3Vic2NyaWJlcnMuYWRkKG5ldyBXZWFrUmVmKGRlbGV0ZVN1YnNjcmliZXIpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5vdGlmeVB1dChlbnRpdHkpIHtcbiAgICAgICAgbGV0IHRvUmVtb3ZlQXJyYXkgPSBbXTtcbiAgICAgICAgdGhpcy5wdXRTdWJzY3JpYmVycy5mb3JFYWNoKCh3ZWFrUmVmU3Vic2NyaWJlciwgcGFyZW50KSA9PiB7XG4gICAgICAgICAgICAvKiogQHR5cGUge09iamVjdEZ1bmN0aW9ufSAqL1xuICAgICAgICAgICAgbGV0IHN1YnNjcmliZXIgPSB3ZWFrUmVmU3Vic2NyaWJlci5kZXJlZigpO1xuICAgICAgICAgICAgaWYgKCFzdWJzY3JpYmVyKSB7XG4gICAgICAgICAgICAgICAgdG9SZW1vdmVBcnJheS5wdXNoKHdlYWtSZWZTdWJzY3JpYmVyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3Vic2NyaWJlci5jYWxsKGVudGl0eSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIG5ldyBMaXN0KHRvUmVtb3ZlQXJyYXkpLmZvckVhY2goKHRvUmVtb3ZlLCBwYXJlbnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMucHV0U3Vic2NyaWJlcnMucmVtb3ZlKHRvUmVtb3ZlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbm90aWZ5RGVsZXRlKGtleSkge1xuICAgICAgICBsZXQgdG9SZW1vdmVBcnJheSA9IFtdO1xuICAgICAgICB0aGlzLmRlbGV0ZVN1YnNjcmliZXJzLmZvckVhY2goKHdlYWtSZWZTdWJzY3JpYmVyLCBwYXJlbnQpID0+IHtcbiAgICAgICAgICAgIC8qKiBAdHlwZSB7T2JqZWN0RnVuY3Rpb259ICovXG4gICAgICAgICAgICBsZXQgc3Vic2NyaWJlciA9IHdlYWtSZWZTdWJzY3JpYmVyLmRlcmVmKCk7XG4gICAgICAgICAgICBpZiAoIXN1YnNjcmliZXIpIHtcbiAgICAgICAgICAgICAgICB0b1JlbW92ZUFycmF5LnB1c2god2Vha1JlZlN1YnNjcmliZXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzdWJzY3JpYmVyLmNhbGwoa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgbmV3IExpc3QodG9SZW1vdmVBcnJheSkuZm9yRWFjaCgodG9SZW1vdmUsIHBhcmVudCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kZWxldGVTdWJzY3JpYmVycy5yZW1vdmUodG9SZW1vdmUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbn0iLCJpbXBvcnQgeyBNYXAsIE9iamVjdEZ1bmN0aW9uIH0gZnJvbSBcImNvcmV1dGlsX3YxXCI7XG5pbXBvcnQgeyBDb250YWluZXJEYXRhYmFzZVN0b3JhZ2UgfSBmcm9tIFwiY29udGFpbmVyYnJpZGdlX3YxXCI7XG5pbXBvcnQgeyBEQkNvbmZpZ3VyZXIgfSBmcm9tIFwiLi9kYkNvbmZpZ3VyZXIuanNcIjtcbmltcG9ydCB7IFN0b3JlQ29uZmlnIH0gZnJvbSBcIi4vc3RvcmVDb25maWcuanNcIjtcbmltcG9ydCB7IFN1YnNjcmlwdGlvbk1hbmFnZXIgfSBmcm9tIFwiLi9zdWJzY3JpcHRpb25NYW5hZ2VyLmpzXCI7XG5pbXBvcnQgeyBEYkNvbmZpZyB9IGZyb20gXCIuL0RiQ29uZmlnLmpzXCI7XG5cbi8qKlxuICogTWFuYWdlcyBhIGRhdGFiYXNlIHdpdGggMCB0byBtYW55IHN0b3Jlc1xuICovXG5leHBvcnQgY2xhc3MgREJNYW5hZ2VyIHtcblxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7SURCRGF0YWJhc2V9IGRiIFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKGRiKSB7XG4gICAgICAgIFxuICAgICAgICAvKiogQHR5cGUge0lEQkRhdGFiYXNlfSAqL1xuICAgICAgICB0aGlzLmRiID0gZGI7XG5cbiAgICAgICAgLyoqIEB0eXBlIHtNYXB9ICovXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcCA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZGJOYW1lIFxuICAgICAqIEBwYXJhbSB7RGJDb25maWd9IGRiQ29uZmlnIFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9XG4gICAgICovXG4gICAgc3RhdGljIGZyb21TdG9yZShkYk5hbWUsIGRiQ29uZmlnKSB7XG4gICAgICAgIGNvbnN0IGRiQ29uZmlndXJlciA9IG5ldyBEQkNvbmZpZ3VyZXIoZGJDb25maWcpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3BlblJlcXVlc3QgPSBDb250YWluZXJEYXRhYmFzZVN0b3JhZ2Uub3BlbihkYk5hbWUsIGRiQ29uZmlnLnZlcnNpb24pO1xuICAgICAgICAgICAgb3BlblJlcXVlc3Qub25lcnJvciA9IChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIExPRy5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wZW5SZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBEQk1hbmFnZXIob3BlblJlcXVlc3QucmVzdWx0KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvcGVuUmVxdWVzdC5vbnVwZ3JhZGVuZWVkZWQgPSBkYkNvbmZpZ3VyZXIudXBkZ3JhZGUuYmluZChkYkNvbmZpZ3VyZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgICAqL1xuICAgIHN0YXRpYyBtYXBFbnRpdHkodHlwZSwgZGF0YU9iamVjdCkge1xuICAgICAgICBpZiAoZGF0YU9iamVjdCkge1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IHR5cGUsIGRhdGFPYmplY3QpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHN0b3JlTmFtZSBcbiAgICAgKiBAcGFyYW0ge0lEQlRyYW5zYWN0aW9uTW9kZX0gdHJhbnNhY3Rpb25UeXBlIHJlYWR3cml0ZVxuICAgICAqIEByZXR1cm5zIHtJREJUcmFuc2FjdGlvbn1cbiAgICAgKi9cbiAgICB0cmFuc2FjdGlvbih0cmFuc2FjdGlvblR5cGUsIHN0b3JlTmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi50cmFuc2FjdGlvbihzdG9yZU5hbWUsIHRyYW5zYWN0aW9uVHlwZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtJREJUcmFuc2FjdGlvbn0gdHJhbnNhY3Rpb25cbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc3RvcmVOYW1lXG4gICAgICogQHJldHVybnMge0lEQk9qZWN0U3RvcmV9XG4gICAgICovXG4gICAgb2JqZWN0U3RvcmUodHJhbnNhY3Rpb24sIHN0b3JlTmFtZSkge1xuICAgICAgICByZXR1cm4gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge0lEQk9iamVjdFN0b3JlfSBvYmplY3RTdG9yZSBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5kZXhOYW1lXG4gICAgICogQHJldHVybnMge0lEQkluZGV4fVxuICAgICAqL1xuICAgIGluZGV4KG9iamVjdFN0b3JlLCBpbmRleE5hbWUpIHtcbiAgICAgICAgcmV0dXJuIG9iamVjdFN0b3JlLmluZGV4KGluZGV4TmFtZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IGVudGl0eVxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdG9yZU5hbWVcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHJhbnNhY3Rpb25UeXBlXG4gICAgICogQHJldHVybiB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBwdXRFbnRpdHkoZW50aXR5LCBzdG9yZU5hbWUpIHtcbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLnRyYW5zYWN0aW9uKFwicmVhZHdyaXRlXCIsIHN0b3JlTmFtZSk7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcbiAgICAgICAgY29uc3QgcHV0UmVxdWVzdCA9IHN0b3JlLnB1dChlbnRpdHkpO1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHB1dFJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4geyBjb250ZXh0Lm5vdGlmeVB1dChlbnRpdHksIHN0b3JlTmFtZSk7IHJlc29sdmUoZW50aXR5KTsgfTtcbiAgICAgICAgICAgIHB1dFJlcXVlc3Qub25lcnJvciA9IChlcnJvcikgPT4geyByZWplY3QoZXJyb3IpOyB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgICAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzdG9yZU5hbWVcbiAgICAgKiBAcGFyYW0ge0NsYXNzfSB0eXBlXG4gICAgICogQHJldHVybnMge1Byb21pc2V9XG4gICAgICovXG4gICAgZ2V0RW50aXR5KGtleSwgdHlwZSwgc3RvcmVOYW1lKSB7XG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy50cmFuc2FjdGlvbihcInJlYWRvbmx5XCIsIHN0b3JlTmFtZSk7XG4gICAgICAgIGNvbnN0IHVzZXJTdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHN0b3JlTmFtZSk7XG4gICAgICAgIGNvbnN0IGdldFJlcXVlc3QgPSB1c2VyU3RvcmUuZ2V0KGtleSk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBnZXRSZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHsgcmVzb2x2ZShEQk1hbmFnZXIubWFwRW50aXR5KHR5cGUsIGdldFJlcXVlc3QucmVzdWx0KSk7IH07XG4gICAgICAgICAgICBnZXRSZXF1ZXN0Lm9uZXJyb3IgPSAoZXJyb3IpID0+IHsgcmVqZWN0KGVycm9yKTsgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBcbiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX1cbiAgICAgKi9cbiAgICBkZWxldGVFbnRpdHkoa2V5LCBzdG9yZU5hbWUpIHtcbiAgICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLnRyYW5zYWN0aW9uKFwicmVhZHdyaXRlXCIsIHN0b3JlTmFtZSk7XG4gICAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKTtcbiAgICAgICAgY29uc3QgZGVsZXRlUmVxdWVzdCA9IHN0b3JlLmRlbGV0ZShrZXkpO1xuICAgICAgICBjb25zdCBjb250ZXh0ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4geyAgY29udGV4dC5ub3RpZnlEZWxldGUoa2V5LCBzdG9yZU5hbWUpOyByZXNvbHZlKGRlbGV0ZVJlcXVlc3QucmVzdWx0KTsgfTtcbiAgICAgICAgICAgIGRlbGV0ZVJlcXVlc3Qub25lcnJvciA9IChlcnJvcikgPT4ge3JlamVjdChlcnJvcik7IH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIG5vdGlmeURlbGV0ZShrZXksIHN0b3JlTmFtZSkge1xuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmNvbnRhaW5zKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5nZXQoc3RvcmVOYW1lKS5ub3RpZnlEZWxldGUoa2V5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5vdGlmeVB1dChlbnRpdHksIHN0b3JlTmFtZSkge1xuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmNvbnRhaW5zKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5nZXQoc3RvcmVOYW1lKS5ub3RpZnlQdXQoZW50aXR5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXJzIGFyZSB3ZWFrbHkgcmVmZXJlbmNlZC4gS2VlcCBhIHJlZmVyZW5jZSB0byB0aGUgXG4gICAgICogaW5zdGFuY2Ugb2YgdGhlIE9iamVjdEZ1bmN0aW9uIHRvIGVuc3VyZSBpdCBpcyBub3QgYXV0b21hdGljYWxseVxuICAgICAqIHJlbW92ZWQuXG4gICAgICogXG4gICAgICogQHR5cGUge1N0cmluZ30gc3RvcmVOYW1lXG4gICAgICogQHR5cGUge09iamVjdEZ1bmN0aW9ufSBvYmplY3RGdW5jdGlvblxuICAgICAqL1xuICAgIHN1YnNjcmliZVB1dChzdG9yZU5hbWUsIG9iamVjdEZ1bmN0aW9uKSB7XG4gICAgICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmNvbnRhaW5zKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5zZXQoc3RvcmVOYW1lLCBuZXcgU3Vic2NyaXB0aW9uTWFuYWdlcigpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuZ2V0KHN0b3JlTmFtZSkuc3Vic2NyaWJlKG9iamVjdEZ1bmN0aW9uKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdWJzY3JpYmVycyBhcmUgd2Vha2x5IHJlZmVyZW5jZWQuIEtlZXAgYSByZWZlcmVuY2UgdG8gdGhlIFxuICAgICAqIGluc3RhbmNlIG9mIHRoZSBPYmplY3RGdW5jdGlvbiB0byBlbnN1cmUgaXQgaXMgbm90IGF1dG9tYXRpY2FsbHlcbiAgICAgKiByZW1vdmVkLlxuICAgICAqIFxuICAgICAqIEB0eXBlIHtTdHJpbmd9IHN0b3JlTmFtZVxuICAgICAqIEB0eXBlIHtPYmplY3RGdW5jdGlvbn0gcHV0T2JqZWN0RnVuY3Rpb25cbiAgICAgKiBAdHlwZSB7T2JqZWN0RnVuY3Rpb259IGRlbGV0ZU9iamVjdEZ1bmN0aW9uXG4gICAgICovXG4gICAgc3Vic2NyaWJlKHB1dE9iamVjdEZ1bmN0aW9uLCBkZWxldGVPYmplY3RGdW5jdGlvbiwgc3RvcmVOYW1lKSB7XG4gICAgICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb25NYW5hZ2VyTWFwLmNvbnRhaW5zKHN0b3JlTmFtZSkpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uTWFuYWdlck1hcC5zZXQoc3RvcmVOYW1lLCBuZXcgU3Vic2NyaXB0aW9uTWFuYWdlcigpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbk1hbmFnZXJNYXAuZ2V0KHN0b3JlTmFtZSkuc3Vic2NyaWJlKHB1dE9iamVjdEZ1bmN0aW9uLCBkZWxldGVPYmplY3RGdW5jdGlvbik7XG4gICAgfVxuXG59Il0sIm5hbWVzIjpbIkxPRyJdLCJtYXBwaW5ncyI6Ijs7O0FBQU8sTUFBTSxXQUFXLENBQUM7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUNwQztBQUNBO0FBQ0EsUUFBUSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUN6QjtBQUNBO0FBQ0EsUUFBUSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUN6QjtBQUNBO0FBQ0EsUUFBUSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztBQUM3QixLQUFLO0FBQ0w7QUFDQTs7QUNqQk8sTUFBTSxXQUFXLENBQUM7QUFD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
